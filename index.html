const fileInput = document.getElementById('fileInput');
const movieInput = document.getElementById('movieInput');
const unranked = document.getElementById('unranked-area');
const tiers = document.querySelectorAll('.tier');
const OMDB_API_KEY = "ee77ebb9";

// Check if device is mobile
function isMobile() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Poster click for mobile
function initMobilePosterClick() {
  if (!isMobile()) return;

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('poster')) {
      currentSelectedPoster = e.target;
      const popup = document.getElementById('mobileTierPopup');
      popup.style.display = 'flex';
    }
  });

  const popupButtons = document.querySelectorAll('.mobile-tier-btn');
  popupButtons.forEach(btn => {
    if (btn.id === 'cancelMobileSelect') {
      btn.addEventListener('click', () => {
        document.getElementById('mobileTierPopup').style.display = 'none';
      });
    } else {
      btn.addEventListener('click', () => {
        const tierName = btn.dataset.tier;
        const targetTier = document.querySelector(`.tier[data-tier="${tierName}"]`);
        if (currentSelectedPoster && targetTier) {
          targetTier.appendChild(currentSelectedPoster);
          document.getElementById('mobileTierPopup').style.display = 'none';
        }
      });
    }
  });
}

let currentSelectedPoster = null;

movieInput.addEventListener('keypress', async (e) => {
  if (e.key === 'Enter') {
    const movieName = e.target.value.trim();
    if (!movieName) return;

    try {
      // Search for multiple results
      const searchResponse = await fetch(`https://www.omdbapi.com/?s=${encodeURIComponent(movieName)}&apikey=${OMDB_API_KEY}`);
      const searchData = await searchResponse.json();

      if (searchData.Response === "False") {
        alert("Movie not found 😕\nTry another name or in English.");
        return;
      }

      if (!searchData.Search || searchData.Search.length === 0) {
        alert("No results found. Try a different title.");
        return;
      }

      // Show modal with results + posters
      showSearchResultsWithPosters(searchData.Search);

    } catch (error) {
      alert("Something went wrong. Check your internet?");
      console.error(error);
    }
  }
});

// Show search results with posters
async function showSearchResultsWithPosters(results) {
  const modal = document.getElementById('searchResultsModal');
  const list = document.getElementById('searchResultsList');
  list.innerHTML = '';

  for (const result of results) {
    // Fetch full details to get poster
    try {
      const detailResponse = await fetch(`https://www.omdbapi.com/?i=${result.imdbID}&apikey=${OMDB_API_KEY}`);
      const data = await detailResponse.json();

      const item = document.createElement('div');
      item.className = 'search-result-item';
      item.innerHTML = `
        <img class="search-poster" src="${data.Poster && data.Poster !== 'N/A' ? data.Poster : 'https://via.placeholder.com/60x90/333/fff?text=No+Poster'}" alt="${data.Title}">
        <div class="search-info">
          <div class="search-title">${data.Title}
          <div class="search-year-type">${data.Year} • ${data.Type}
        
      `;

      item.addEventListener('click', () => {
        addMovieToBoard(data);
        modal.classList.remove('active');
      });

      list.appendChild(item);
    } catch (err) {
      console.error("Error fetching movie details:", err);
    }
  }

  modal.classList.add('active');
}

// Add selected movie to board
function addMovieToBoard(data) {
  if (!data.Poster || data.Poster === "N/A") {
    alert("No poster available for this movie 🖼️");
    return;
  }

  const img = document.createElement('img');
  img.src = data.Poster;
  img.alt = data.Title;
  img.title = `${data.Title} (${data.Year}) • ${data.Type}`;
  img.classList.add('poster');
  img.draggable = true;
  img.dataset.movieTitle = data.Title;

  // Add delete button
  const deleteBtn = document.createElement('div');
  deleteBtn.innerHTML = '🗑️';
  deleteBtn.className = 'delete-btn';
  deleteBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    if (confirm('Delete this movie?')) {
      img.remove();
    }
  });
  img.appendChild(deleteBtn);

  img.addEventListener('dragstart', dragStart);

  if (isMobile()) {
    img.addEventListener('click', function() {
      currentSelectedPoster = this;
      document.getElementById('mobileTierPopup').style.display = 'flex';
    });
  }

  img.onload = () => {
    unranked.appendChild(img);
    movieInput.value = '';
    movieInput.placeholder = "🎬 Try another one...";
  };

  img.onerror = () => {
    alert("Error loading image. Try again?");
  };
}

// Manual image upload
fileInput.addEventListener('change', (event) => {
  const files = event.target.files;
  for (const file of files) {
    if (!file.type.startsWith('image/')) continue;
    const reader = new FileReader();
    reader.onload = (e) => {
      const img = document.createElement('img');
      img.src = e.target.result;
      img.classList.add('poster');
      img.draggable = true;
      img.dataset.originalSrc = e.target.result;

      // Add delete button
      const deleteBtn = document.createElement('div');
      deleteBtn.innerHTML = '🗑️';
      deleteBtn.className = 'delete-btn';
      deleteBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm('Delete this movie?')) {
          img.remove();
        }
      });
      img.appendChild(deleteBtn);

      img.addEventListener('dragstart', dragStart);

      if (isMobile()) {
        img.addEventListener('click', function() {
          currentSelectedPoster = this;
          document.getElementById('mobileTierPopup').style.display = 'flex';
        });
      }

      unranked.appendChild(img);
    };
    reader.readAsDataURL(file);
  }
});

function dragStart(e) {
  e.dataTransfer.setData('text/plain', e.target.src);
}

tiers.forEach(tier => {
  tier.addEventListener('dragover', (e) => e.preventDefault());
  tier.addEventListener('drop', (e) => {
    e.preventDefault();
    const src = e.dataTransfer.getData('text/plain');
    const img = document.querySelector(`img[src='${src}']`);
    if (img) tier.appendChild(img);
  });
});

unranked.addEventListener('dragover', (e) => e.preventDefault());
unranked.addEventListener('drop', (e) => {
  e.preventDefault();
  const src = e.dataTransfer.getData('text/plain');
  const img = document.querySelector(`img[src='${src}']`);
  if (img) unranked.appendChild(img);
});

document.getElementById('resetBtn').addEventListener('click', () => {
  const allPosters = document.querySelectorAll('.poster');
  allPosters.forEach(poster => unranked.appendChild(poster));
});

document.getElementById('downloadBtn').addEventListener('click', () => {
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
  script.onload = () => {
    const element = document.querySelector('.tier-list').parentNode;
    html2canvas(element, {
      backgroundColor: '#0a0a0a',
      scale: 2,
      useCORS: true,
      allowTaint: true
    }).then(canvas => {
      const link = document.createElement('a');
      link.download = 'my-movie-tierlist.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });
  };
  document.head.appendChild(script);
});

const settingsBtn = document.getElementById('settingsBtn');
const closeSettings = document.getElementById('closeSettings');
const modalOverlay = document.getElementById('settingsModal');
const tierInputs = document.querySelectorAll('.tier-input');

settingsBtn.addEventListener('click', () => {
  modalOverlay.classList.add('active');
});

closeSettings.addEventListener('click', () => {
  modalOverlay.classList.remove('active');
});

modalOverlay.addEventListener('click', (e) => {
  if (e.target === modalOverlay) {
    modalOverlay.classList.remove('active');
  }
});

tierInputs.forEach(input => {
  input.addEventListener('input', function() {
    const targetTier = this.dataset.target;
    const labelElement = document.querySelector(`.tier[data-tier="${targetTier}"] .tier-label`);
    if (labelElement) {
      labelElement.textContent = this.value;
    }
  });
});

// 💾 Save List Functionality
let listCounter = 1;

document.getElementById('saveListBtn').addEventListener('click', () => {
  const tiersData = {};
  document.querySelectorAll('.tier').forEach(tier => {
    const tierName = tier.dataset.tier;
    const posters = Array.from(tier.querySelectorAll('.poster')).map(img => ({
      src: img.src,
      alt: img.alt,
      title: img.title
    }));
    tiersData[tierName] = posters;
  });

  const unrankedPosters = Array.from(document.querySelectorAll('#unranked-area .poster')).map(img => ({
    src: img.src,
    alt: img.alt,
    title: img.title
  }));
  tiersData.unranked = unrankedPosters;

  const listName = `List ${listCounter}`;
  localStorage.setItem(listName, JSON.stringify(tiersData));
  alert(`✅ Saved as "${listName}"`);
  listCounter++;
});

// 📚 Load History Modal
const historyModal = document.getElementById('historyModal');

document.getElementById('loadHistoryBtn').addEventListener('click', () => {
  const historyList = document.getElementById('historyList');
  historyList.innerHTML = '';

  let hasLists = false;
  for (let i = 1; i <= 50; i++) {
    const key = `List ${i}`;
    const saved = localStorage.getItem(key);
    if (saved) {
      hasLists = true;
      const btn = document.createElement('div');
      btn.style.padding = '12px';
      btn.style.margin = '8px 0';
      btn.style.background = '#333';
      btn.style.borderRadius = '8px';
      btn.style.cursor = 'pointer';
      btn.style.textAlign = 'center';
      btn.textContent = key;
      btn.addEventListener('click', () => {
        loadList(key);
        historyModal.classList.remove('active');
      });
      historyList.appendChild(btn);
    }
  }

  if (!hasLists) {
    historyList.innerHTML = '<p style="text-align:center; color:#aaa;">No saved lists yet.';
  }

  historyModal.classList.add('active');
});

document.getElementById('closeHistory').addEventListener('click', () => {
  historyModal.classList.remove('active');
});

historyModal.addEventListener('click', (e) => {
  if (e.target === historyModal) {
    historyModal.classList.remove('active');
  }
});

function loadList(listName) {
  const savedData = localStorage.getItem(listName);
  if (!savedData) return;

  const tiersData = JSON.parse(savedData);

  document.querySelectorAll('.poster').forEach(p => p.remove());

  for (const tierName in tiersData) {
    if (tierName === 'unranked') continue;
    const tierEl = document.querySelector(`.tier[data-tier="${tierName}"]`);
    if (tierEl && tiersData[tierName]) {
      tiersData[tierName].forEach(item => {
        const img = document.createElement('img');
        img.src = item.src;
        img.alt = item.alt;
        img.title = item.title;
        img.classList.add('poster');
        img.draggable = true;
        img.addEventListener('dragstart', dragStart);

        // Add delete button
        const deleteBtn = document.createElement('div');
        deleteBtn.innerHTML = '🗑️';
        deleteBtn.className = 'delete-btn';
        deleteBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          if (confirm('Delete this movie?')) {
            img.remove();
          }
        });
        img.appendChild(deleteBtn);

        if (isMobile()) {
          img.addEventListener('click', function() {
            currentSelectedPoster = this;
            document.getElementById('mobileTierPopup').style.display = 'flex';
          });
        }
        tierEl.appendChild(img);
      });
    }
  }

  const unrankedArea = document.getElementById('unranked-area');
  if (tiersData.unranked) {
    tiersData.unranked.forEach(item => {
      const img = document.createElement('img');
      img.src = item.src;
      img.alt = item.alt;
      img.title = item.title;
      img.classList.add('poster');
      img.draggable = true;
      img.addEventListener('dragstart', dragStart);

      // Add delete button
      const deleteBtn = document.createElement('div');
      deleteBtn.innerHTML = '🗑️';
      deleteBtn.className = 'delete-btn';
      deleteBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        if (confirm('Delete this movie?')) {
          img.remove();
        }
      });
      img.appendChild(deleteBtn);

      if (isMobile()) {
        img.addEventListener('click', function() {
          currentSelectedPoster = this;
          document.getElementById('mobileTierPopup').style.display = 'flex';
        });
      }
      unrankedArea.appendChild(img);
    });
  }

  alert(`📂 Loaded "${listName}"`);
}

// 📤 Share List Functionality
document.getElementById('shareBtn').addEventListener('click', () => {
  let shareText = "My Movie Tier List:\n\n";
  
  document.querySelectorAll('.tier').forEach(tier => {
    const tierName = tier.dataset.tier;
    const movies = Array.from(tier.querySelectorAll('.poster')).map(img => img.alt || "Unknown Movie");
    if (movies.length > 0) {
      shareText += `${tierName}: ${movies.join(', ')}\n`;
    }
  });

  const unrankedMovies = Array.from(document.querySelectorAll('#unranked-area .poster')).map(img => img.alt || "Unknown Movie");
  if (unrankedMovies.length > 0) {
    shareText += `\nUnranked: ${unrankedMovies.join(', ')}`;
  }

  shareText += "\n\nCreated with ❤️ by TaL.S";

  if (navigator.share) {
    navigator.share({
      title: 'My Movie Tier List',
      text: shareText
    }).catch(err => {
      fallbackCopyTextToClipboard(shareText);
    });
  } else {
    fallbackCopyTextToClipboard(shareText);
  }
});

function fallbackCopyTextToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert("📋 Copied to clipboard!\nPaste anywhere to share.");
  }).catch(() => {
    prompt("Copy the text below:", text);
  });
}

// Close search results modal
document.getElementById('closeSearchResults').addEventListener('click', () => {
  document.getElementById('searchResultsModal').classList.remove('active');
});

document.getElementById('searchResultsModal').addEventListener('click', (e) => {
  if (e.target === document.getElementById('searchResultsModal')) {
    document.getElementById('searchResultsModal').classList.remove('active');
  }
});

// Initialize mobile features
initMobilePosterClick();
